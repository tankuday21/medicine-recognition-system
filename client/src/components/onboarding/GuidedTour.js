// Guided Tour Component
// Interactive tutorials with element highlighting and step-by-step guidance

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { createPortal } from 'react-dom';
import { interactiveTutorialSystem } from '../../utils/onboardingSystem';
import { Button } from '../ui/Button';
import { Card } from '../ui/Card';\n\n/**\n * Main Guided Tour Component\n */\nexport const GuidedTour = ({ \n  tutorialId,\n  onComplete,\n  onExit,\n  autoStart = false \n}) => {\n  const [isActive, setIsActive] = useState(false);\n  const [currentTutorial, setCurrentTutorial] = useState(null);\n  const [currentStep, setCurrentStep] = useState(null);\n  const [progress, setProgress] = useState(null);\n  const [targetElement, setTargetElement] = useState(null);\n  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });\n  const [isValidated, setIsValidated] = useState(false);\n  const overlayRef = useRef(null);\n  const tooltipRef = useRef(null);\n\n  // Initialize tutorial\n  useEffect(() => {\n    if (tutorialId && autoStart) {\n      startTutorial();\n    }\n  }, [tutorialId, autoStart]);\n\n  // Update target element and position when step changes\n  useEffect(() => {\n    if (currentStep && currentStep.step.target) {\n      updateTargetElement();\n    }\n  }, [currentStep]);\n\n  // Listen for window resize to update positions\n  useEffect(() => {\n    const handleResize = () => {\n      if (targetElement) {\n        updateTooltipPosition();\n      }\n    };\n\n    window.addEventListener('resize', handleResize);\n    return () => window.removeEventListener('resize', handleResize);\n  }, [targetElement]);\n\n  const startTutorial = useCallback(() => {\n    const tutorialData = interactiveTutorialSystem.startTutorial(tutorialId);\n    if (tutorialData) {\n      setCurrentTutorial(tutorialData.tutorial);\n      setCurrentStep({\n        step: tutorialData.currentStep,\n        progress: tutorialData.progress\n      });\n      setProgress(tutorialData.progress);\n      setIsActive(true);\n    }\n  }, [tutorialId]);\n\n  const updateTargetElement = useCallback(() => {\n    if (!currentStep?.step.target) return;\n\n    const element = document.querySelector(currentStep.step.target);\n    if (element) {\n      setTargetElement(element);\n      updateTooltipPosition(element);\n      \n      // Scroll element into view\n      element.scrollIntoView({ \n        behavior: 'smooth', \n        block: 'center',\n        inline: 'center'\n      });\n      \n      // Add highlight class\n      element.classList.add('tour-highlight');\n      \n      // Set up interaction listeners\n      setupInteractionListeners(element);\n    }\n  }, [currentStep]);\n\n  const updateTooltipPosition = useCallback((element = targetElement) => {\n    if (!element || !tooltipRef.current) return;\n\n    const elementRect = element.getBoundingClientRect();\n    const tooltipRect = tooltipRef.current.getBoundingClientRect();\n    const viewportWidth = window.innerWidth;\n    const viewportHeight = window.innerHeight;\n\n    let x = elementRect.left + elementRect.width / 2 - tooltipRect.width / 2;\n    let y = elementRect.bottom + 10;\n\n    // Adjust horizontal position if tooltip goes off screen\n    if (x < 10) {\n      x = 10;\n    } else if (x + tooltipRect.width > viewportWidth - 10) {\n      x = viewportWidth - tooltipRect.width - 10;\n    }\n\n    // Adjust vertical position if tooltip goes off screen\n    if (y + tooltipRect.height > viewportHeight - 10) {\n      y = elementRect.top - tooltipRect.height - 10;\n    }\n\n    setTooltipPosition({ x, y });\n  }, [targetElement]);\n\n  const setupInteractionListeners = useCallback((element) => {\n    if (!currentStep?.step) return;\n\n    const step = currentStep.step;\n    \n    const handleInteraction = (event) => {\n      if (step.type === 'interactive' && step.action) {\n        switch (step.action) {\n          case 'click':\n            if (event.type === 'click') {\n              validateAndProceed(event);\n            }\n            break;\n          case 'input':\n            if (event.type === 'input' || event.type === 'change') {\n              validateAndProceed(event);\n            }\n            break;\n          case 'hover':\n            if (event.type === 'mouseenter') {\n              validateAndProceed(event);\n            }\n            break;\n          default:\n            break;\n        }\n      }\n    };\n\n    // Add event listeners based on step action\n    if (step.action === 'click') {\n      element.addEventListener('click', handleInteraction);\n    } else if (step.action === 'input') {\n      element.addEventListener('input', handleInteraction);\n      element.addEventListener('change', handleInteraction);\n    } else if (step.action === 'hover') {\n      element.addEventListener('mouseenter', handleInteraction);\n    }\n\n    // Store cleanup function\n    element._tourCleanup = () => {\n      element.removeEventListener('click', handleInteraction);\n      element.removeEventListener('input', handleInteraction);\n      element.removeEventListener('change', handleInteraction);\n      element.removeEventListener('mouseenter', handleInteraction);\n      element.classList.remove('tour-highlight');\n    };\n  }, [currentStep]);\n\n  const validateAndProceed = useCallback((event) => {\n    if (!currentStep?.step) return;\n\n    const step = currentStep.step;\n    const isValid = interactiveTutorialSystem.validateStepCompletion(\n      step.id, \n      { event, element: targetElement }\n    );\n\n    if (isValid) {\n      setIsValidated(true);\n      setTimeout(() => {\n        handleStepComplete();\n      }, 500);\n    }\n  }, [currentStep, targetElement]);\n\n  const handleStepComplete = useCallback(() => {\n    if (!currentTutorial || !currentStep) return;\n\n    // Clean up current step\n    if (targetElement && targetElement._tourCleanup) {\n      targetElement._tourCleanup();\n    }\n\n    const completed = interactiveTutorialSystem.completeStep(\n      currentTutorial.id, \n      currentStep.step.id,\n      { timestamp: Date.now() }\n    );\n\n    if (completed) {\n      const nextStep = interactiveTutorialSystem.getCurrentTutorialStep();\n      \n      if (nextStep) {\n        setCurrentStep(nextStep);\n        setProgress(nextStep.progress);\n        setIsValidated(false);\n      } else {\n        // Tutorial completed\n        handleTutorialComplete();\n      }\n    }\n  }, [currentTutorial, currentStep, targetElement]);\n\n  const handleTutorialComplete = useCallback(() => {\n    setIsActive(false);\n    if (onComplete) {\n      onComplete(currentTutorial);\n    }\n  }, [currentTutorial, onComplete]);\n\n  const handleTutorialExit = useCallback(() => {\n    // Clean up\n    if (targetElement && targetElement._tourCleanup) {\n      targetElement._tourCleanup();\n    }\n    \n    setIsActive(false);\n    if (onExit) {\n      onExit(currentTutorial);\n    }\n  }, [currentTutorial, targetElement, onExit]);\n\n  if (!isActive || !currentStep) {\n    return null;\n  }\n\n  return createPortal(\n    <>\n      {/* Overlay */}\n      <motion.div\n        ref={overlayRef}\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        exit={{ opacity: 0 }}\n        className=\"fixed inset-0 z-40 bg-black bg-opacity-50\"\n        style={{ pointerEvents: 'none' }}\n      />\n\n      {/* Spotlight */}\n      {targetElement && (\n        <TourSpotlight \n          targetElement={targetElement}\n          isValidated={isValidated}\n        />\n      )}\n\n      {/* Tooltip */}\n      <motion.div\n        ref={tooltipRef}\n        initial={{ opacity: 0, scale: 0.9 }}\n        animate={{ opacity: 1, scale: 1 }}\n        exit={{ opacity: 0, scale: 0.9 }}\n        className=\"fixed z-50\"\n        style={{\n          left: tooltipPosition.x,\n          top: tooltipPosition.y,\n          pointerEvents: 'auto'\n        }}\n      >\n        <TourTooltip\n          step={currentStep.step}\n          progress={progress}\n          tutorial={currentTutorial}\n          isValidated={isValidated}\n          onNext={handleStepComplete}\n          onExit={handleTutorialExit}\n        />\n      </motion.div>\n    </>,\n    document.body\n  );\n};\n\n/**\n * Tour Spotlight Component\n */\nconst TourSpotlight = ({ targetElement, isValidated }) => {\n  const [elementRect, setElementRect] = useState(null);\n\n  useEffect(() => {\n    if (targetElement) {\n      const updateRect = () => {\n        const rect = targetElement.getBoundingClientRect();\n        setElementRect(rect);\n      };\n\n      updateRect();\n      \n      const observer = new ResizeObserver(updateRect);\n      observer.observe(targetElement);\n      \n      return () => observer.disconnect();\n    }\n  }, [targetElement]);\n\n  if (!elementRect) return null;\n\n  const padding = 8;\n  const spotlightStyle = {\n    left: elementRect.left - padding,\n    top: elementRect.top - padding,\n    width: elementRect.width + padding * 2,\n    height: elementRect.height + padding * 2\n  };\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, scale: 0.8 }}\n      animate={{ \n        opacity: 1, \n        scale: 1,\n        boxShadow: isValidated \n          ? '0 0 0 4px rgba(34, 197, 94, 0.5), 0 0 0 9999px rgba(0, 0, 0, 0.5)'\n          : '0 0 0 4px rgba(59, 130, 246, 0.5), 0 0 0 9999px rgba(0, 0, 0, 0.5)'\n      }}\n      className=\"fixed z-40 bg-transparent rounded-lg pointer-events-none\"\n      style={spotlightStyle}\n      transition={{ duration: 0.3 }}\n    >\n      {isValidated && (\n        <motion.div\n          initial={{ scale: 0 }}\n          animate={{ scale: 1 }}\n          className=\"absolute -top-2 -right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center\"\n        >\n          <svg className=\"w-4 h-4 text-white\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n          </svg>\n        </motion.div>\n      )}\n    </motion.div>\n  );\n};\n\n/**\n * Tour Tooltip Component\n */\nconst TourTooltip = ({ \n  step, \n  progress, \n  tutorial, \n  isValidated, \n  onNext, \n  onExit \n}) => {\n  const getStepIcon = () => {\n    switch (step.type) {\n      case 'interactive':\n        return (\n          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11\" />\n          </svg>\n        );\n      case 'tour':\n        return (\n          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\n          </svg>\n        );\n      default:\n        return (\n          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n          </svg>\n        );\n    }\n  };\n\n  return (\n    <Card className=\"w-80 p-4 shadow-2xl border-2 border-blue-200\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center space-x-2\">\n          <div className=\"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600\">\n            {getStepIcon()}\n          </div>\n          <div>\n            <h3 className=\"font-semibold text-gray-900 text-sm\">\n              {step.title}\n            </h3>\n            <p className=\"text-xs text-gray-500\">\n              Step {progress.current} of {progress.total}\n            </p>\n          </div>\n        </div>\n        \n        <button\n          onClick={onExit}\n          className=\"text-gray-400 hover:text-gray-600 transition-colors\"\n          aria-label=\"Exit tutorial\"\n        >\n          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n          </svg>\n        </button>\n      </div>\n\n      {/* Progress Bar */}\n      <div className=\"w-full bg-gray-200 rounded-full h-2 mb-4\">\n        <motion.div\n          className=\"bg-blue-600 h-2 rounded-full\"\n          initial={{ width: 0 }}\n          animate={{ width: `${progress.percentage}%` }}\n          transition={{ duration: 0.3 }}\n        />\n      </div>\n\n      {/* Content */}\n      <div className=\"mb-4\">\n        <p className=\"text-gray-700 text-sm mb-3\">\n          {step.description}\n        </p>\n        \n        {step.hint && (\n          <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3\">\n            <p className=\"text-yellow-800 text-sm\">\n              ðŸ’¡ {step.hint}\n            </p>\n          </div>\n        )}\n        \n        {step.type === 'interactive' && !isValidated && (\n          <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3\">\n            <p className=\"text-blue-800 text-sm\">\n              ðŸŽ¯ Complete the highlighted action to continue\n            </p>\n          </div>\n        )}\n        \n        {isValidated && (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.9 }}\n            animate={{ opacity: 1, scale: 1 }}\n            className=\"bg-green-50 border border-green-200 rounded-lg p-3\"\n          >\n            <p className=\"text-green-800 text-sm flex items-center\">\n              <svg className=\"w-4 h-4 mr-2\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n              </svg>\n              Great job! Action completed successfully.\n            </p>\n          </motion.div>\n        )}\n      </div>\n\n      {/* Actions */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"text-xs text-gray-500\">\n          {tutorial.estimatedTime && (\n            <span>~{tutorial.estimatedTime} min remaining</span>\n          )}\n        </div>\n        \n        <div className=\"flex space-x-2\">\n          {step.type !== 'interactive' && (\n            <Button\n              size=\"sm\"\n              onClick={onNext}\n              className=\"min-w-[60px]\"\n            >\n              Next\n            </Button>\n          )}\n          \n          {step.type === 'interactive' && isValidated && (\n            <Button\n              size=\"sm\"\n              onClick={onNext}\n              className=\"min-w-[60px]\"\n            >\n              Continue\n            </Button>\n          )}\n        </div>\n      </div>\n    </Card>\n  );\n};\n\n/**\n * Tutorial Launcher Component\n */\nexport const TutorialLauncher = ({ tutorials, onTutorialStart }) => {\n  const [availableTutorials, setAvailableTutorials] = useState([]);\n\n  useEffect(() => {\n    const available = interactiveTutorialSystem.getAvailableTutorials();\n    setAvailableTutorials(available);\n  }, []);\n\n  const handleStartTutorial = (tutorialId) => {\n    if (onTutorialStart) {\n      onTutorialStart(tutorialId);\n    }\n  };\n\n  if (availableTutorials.length === 0) {\n    return null;\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <h3 className=\"text-lg font-semibold text-gray-900\">\n        Available Tutorials\n      </h3>\n      \n      <div className=\"grid gap-4\">\n        {availableTutorials.map((tutorial) => (\n          <Card key={tutorial.id} className=\"p-4\">\n            <div className=\"flex items-start justify-between\">\n              <div className=\"flex-1\">\n                <h4 className=\"font-medium text-gray-900 mb-1\">\n                  {tutorial.title}\n                </h4>\n                <p className=\"text-sm text-gray-600 mb-2\">\n                  {tutorial.description}\n                </p>\n                \n                <div className=\"flex items-center space-x-4 text-xs text-gray-500\">\n                  <span>~{tutorial.estimatedTime} minutes</span>\n                  <span className=\"capitalize\">{tutorial.difficulty}</span>\n                  {tutorial.status === 'in-progress' && (\n                    <span className=\"text-blue-600 font-medium\">\n                      {Math.round(tutorial.progress.percentage)}% complete\n                    </span>\n                  )}\n                </div>\n              </div>\n              \n              <Button\n                size=\"sm\"\n                onClick={() => handleStartTutorial(tutorial.id)}\n                className=\"ml-4\"\n              >\n                {tutorial.status === 'in-progress' ? 'Continue' : 'Start'}\n              </Button>\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n};\n\nexport default GuidedTour;"