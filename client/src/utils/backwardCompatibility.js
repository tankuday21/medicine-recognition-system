// Backward Compatibility Layer
// Ensures existing functionality continues to work with premium components

import React from 'react';
import { performanceMonitor } from './performanceMonitor';

/**
 * Backward Compatibility Manager
 * Provides compatibility shims and fallbacks for legacy code
 */
export class BackwardCompatibilityManager {
  constructor() {\n    this.compatibilityShims = new Map();\n    this.fallbackComponents = new Map();\n    this.deprecationWarnings = new Set();\n    this.errorBoundaries = new Map();\n    \n    this.initializeCompatibilityLayer();\n  }\n\n  /**\n   * Initialize the compatibility layer\n   */\n  initializeCompatibilityLayer() {\n    this.setupGlobalShims();\n    this.setupComponentFallbacks();\n    this.setupEventCompatibility();\n    this.setupStyleCompatibility();\n  }\n\n  /**\n   * Setup global JavaScript shims\n   */\n  setupGlobalShims() {\n    // Ensure global objects exist\n    if (typeof window !== 'undefined') {\n      // Legacy jQuery-style selectors (if used)\n      if (!window.$) {\n        window.$ = (selector) => {\n          this.warnDeprecation('jQuery-style selectors', 'Use React refs or modern DOM APIs');\n          return document.querySelector(selector);\n        };\n      }\n\n      // Legacy event handling\n      if (!window.addEvent) {\n        window.addEvent = (element, event, handler) => {\n          this.warnDeprecation('addEvent function', 'Use React event handlers');\n          if (element && element.addEventListener) {\n            element.addEventListener(event, handler);\n          }\n        };\n      }\n\n      // Legacy AJAX functions (if used)\n      if (!window.makeRequest) {\n        window.makeRequest = (url, callback) => {\n          this.warnDeprecation('makeRequest function', 'Use fetch API or axios');\n          fetch(url)\n            .then(response => response.json())\n            .then(callback)\n            .catch(error => console.error('Legacy request failed:', error));\n        };\n      }\n    }\n  }\n\n  /**\n   * Setup component fallbacks\n   */\n  setupComponentFallbacks() {\n    // Button fallback\n    this.fallbackComponents.set('Button', {\n      component: this.createButtonFallback(),\n      reason: 'Premium Button component failed to load'\n    });\n\n    // Input fallback\n    this.fallbackComponents.set('Input', {\n      component: this.createInputFallback(),\n      reason: 'Premium Input component failed to load'\n    });\n\n    // Card fallback\n    this.fallbackComponents.set('Card', {\n      component: this.createCardFallback(),\n      reason: 'Premium Card component failed to load'\n    });\n\n    // Modal fallback\n    this.fallbackComponents.set('Modal', {\n      component: this.createModalFallback(),\n      reason: 'Premium Modal component failed to load'\n    });\n  }\n\n  /**\n   * Create Button fallback component\n   */\n  createButtonFallback() {\n    return React.forwardRef((props, ref) => {\n      const {\n        variant = 'primary',\n        size = 'md',\n        loading = false,\n        disabled = false,\n        fullWidth = false,\n        leftIcon,\n        rightIcon,\n        children,\n        className = '',\n        ...otherProps\n      } = props;\n\n      // Map variants to CSS classes\n      const variantClasses = {\n        primary: 'bg-blue-600 text-white hover:bg-blue-700',\n        secondary: 'bg-gray-600 text-white hover:bg-gray-700',\n        danger: 'bg-red-600 text-white hover:bg-red-700',\n        success: 'bg-green-600 text-white hover:bg-green-700',\n        outline: 'border border-gray-300 text-gray-700 hover:bg-gray-50'\n      };\n\n      // Map sizes to CSS classes\n      const sizeClasses = {\n        sm: 'px-3 py-1.5 text-sm',\n        md: 'px-4 py-2 text-base',\n        lg: 'px-6 py-3 text-lg'\n      };\n\n      const buttonClasses = [\n        'inline-flex items-center justify-center font-medium rounded-md transition-colors',\n        'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500',\n        'disabled:opacity-50 disabled:cursor-not-allowed',\n        'min-h-[44px]', // Touch target\n        variantClasses[variant] || variantClasses.primary,\n        sizeClasses[size] || sizeClasses.md,\n        fullWidth ? 'w-full' : '',\n        className\n      ].filter(Boolean).join(' ');\n\n      return (\n        <button\n          ref={ref}\n          className={buttonClasses}\n          disabled={disabled || loading}\n          {...otherProps}\n        >\n          {loading && (\n            <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\">\n              <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n              <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n            </svg>\n          )}\n          {leftIcon && <span className=\"mr-2\">{leftIcon}</span>}\n          {children}\n          {rightIcon && <span className=\"ml-2\">{rightIcon}</span>}\n        </button>\n      );\n    });\n  }\n\n  /**\n   * Create Input fallback component\n   */\n  createInputFallback() {\n    return React.forwardRef((props, ref) => {\n      const {\n        variant = 'default',\n        size = 'md',\n        error = false,\n        className = '',\n        ...otherProps\n      } = props;\n\n      const sizeClasses = {\n        sm: 'px-3 py-1.5 text-sm',\n        md: 'px-3 py-2 text-base',\n        lg: 'px-4 py-3 text-lg'\n      };\n\n      const inputClasses = [\n        'block w-full rounded-md border-gray-300 shadow-sm',\n        'focus:border-blue-500 focus:ring-blue-500',\n        'disabled:bg-gray-50 disabled:text-gray-500',\n        'min-h-[44px]', // Touch target\n        sizeClasses[size] || sizeClasses.md,\n        error ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : '',\n        className\n      ].filter(Boolean).join(' ');\n\n      return (\n        <input\n          ref={ref}\n          className={inputClasses}\n          {...otherProps}\n        />\n      );\n    });\n  }\n\n  /**\n   * Create Card fallback component\n   */\n  createCardFallback() {\n    return React.forwardRef((props, ref) => {\n      const {\n        variant = 'default',\n        hoverable = false,\n        className = '',\n        children,\n        onClick,\n        ...otherProps\n      } = props;\n\n      const cardClasses = [\n        'bg-white rounded-lg shadow border border-gray-200',\n        hoverable ? 'hover:shadow-md transition-shadow cursor-pointer' : '',\n        className\n      ].filter(Boolean).join(' ');\n\n      const CardElement = onClick ? 'button' : 'div';\n\n      return (\n        <CardElement\n          ref={ref}\n          className={cardClasses}\n          onClick={onClick}\n          {...otherProps}\n        >\n          {children}\n        </CardElement>\n      );\n    });\n  }\n\n  /**\n   * Create Modal fallback component\n   */\n  createModalFallback() {\n    return React.forwardRef((props, ref) => {\n      const {\n        isOpen = false,\n        onClose,\n        className = '',\n        children,\n        ...otherProps\n      } = props;\n\n      if (!isOpen) return null;\n\n      return (\n        <div className=\"fixed inset-0 z-50 overflow-y-auto\">\n          <div className=\"flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0\">\n            {/* Backdrop */}\n            <div \n              className=\"fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75\"\n              onClick={onClose}\n            ></div>\n\n            {/* Modal */}\n            <div\n              ref={ref}\n              className={[\n                'inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full',\n                className\n              ].filter(Boolean).join(' ')}\n              {...otherProps}\n            >\n              {children}\n            </div>\n          </div>\n        </div>\n      );\n    });\n  }\n\n  /**\n   * Setup event compatibility\n   */\n  setupEventCompatibility() {\n    // Handle legacy event names\n    this.compatibilityShims.set('onchange', 'onChange');\n    this.compatibilityShims.set('onclick', 'onClick');\n    this.compatibilityShims.set('onsubmit', 'onSubmit');\n    this.compatibilityShims.set('onfocus', 'onFocus');\n    this.compatibilityShims.set('onblur', 'onBlur');\n  }\n\n  /**\n   * Setup style compatibility\n   */\n  setupStyleCompatibility() {\n    // Inject compatibility CSS if needed\n    if (typeof document !== 'undefined') {\n      const compatibilityCSS = `\n        /* Legacy button styles */\n        .btn {\n          display: inline-flex;\n          align-items: center;\n          justify-content: center;\n          padding: 0.5rem 1rem;\n          border-radius: 0.375rem;\n          font-weight: 500;\n          transition: all 0.2s;\n          min-height: 44px;\n        }\n        \n        .btn-primary {\n          background-color: #3b82f6;\n          color: white;\n        }\n        \n        .btn-primary:hover {\n          background-color: #2563eb;\n        }\n        \n        /* Legacy card styles */\n        .card {\n          background-color: white;\n          border-radius: 0.5rem;\n          box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);\n          border: 1px solid #e5e7eb;\n        }\n        \n        .card-body {\n          padding: 1.5rem;\n        }\n        \n        /* Legacy form styles */\n        .form-control {\n          display: block;\n          width: 100%;\n          padding: 0.5rem 0.75rem;\n          border: 1px solid #d1d5db;\n          border-radius: 0.375rem;\n          min-height: 44px;\n        }\n        \n        .form-control:focus {\n          outline: none;\n          border-color: #3b82f6;\n          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);\n        }\n        \n        /* Touch targets */\n        .touch-target {\n          min-height: 44px;\n          min-width: 44px;\n        }\n      `;\n\n      // Check if compatibility styles are already injected\n      if (!document.getElementById('backward-compatibility-styles')) {\n        const styleElement = document.createElement('style');\n        styleElement.id = 'backward-compatibility-styles';\n        styleElement.textContent = compatibilityCSS;\n        document.head.appendChild(styleElement);\n      }\n    }\n  }\n\n  /**\n   * Get fallback component\n   */\n  getFallbackComponent(componentName) {\n    const fallback = this.fallbackComponents.get(componentName);\n    \n    if (fallback) {\n      console.warn(`Using fallback component for ${componentName}: ${fallback.reason}`);\n      \n      // Track fallback usage\n      performanceMonitor.recordMetric('fallbackUsage', {\n        component: componentName,\n        reason: fallback.reason\n      });\n      \n      return fallback.component;\n    }\n    \n    return null;\n  }\n\n  /**\n   * Transform legacy props to modern props\n   */\n  transformProps(props) {\n    const transformed = { ...props };\n    \n    // Transform event handlers\n    Object.keys(props).forEach(key => {\n      const modernKey = this.compatibilityShims.get(key.toLowerCase());\n      if (modernKey && modernKey !== key) {\n        transformed[modernKey] = props[key];\n        delete transformed[key];\n        \n        this.warnDeprecation(\n          `Event handler '${key}'`,\n          `Use '${modernKey}' instead`\n        );\n      }\n    });\n    \n    // Transform class to className\n    if (props.class && !props.className) {\n      transformed.className = props.class;\n      delete transformed.class;\n      \n      this.warnDeprecation(\n        \"'class' attribute\",\n        \"Use 'className' instead\"\n      );\n    }\n    \n    return transformed;\n  }\n\n  /**\n   * Show deprecation warning\n   */\n  warnDeprecation(feature, replacement) {\n    const warning = `${feature} is deprecated. ${replacement}`;\n    \n    // Only show each warning once\n    if (!this.deprecationWarnings.has(warning)) {\n      console.warn(`[Backward Compatibility] ${warning}`);\n      this.deprecationWarnings.add(warning);\n      \n      // Track deprecation usage\n      performanceMonitor.recordMetric('deprecationWarning', {\n        feature,\n        replacement\n      });\n    }\n  }\n\n  /**\n   * Create error boundary for component fallbacks\n   */\n  createErrorBoundary(componentName, fallbackComponent) {\n    return class ComponentErrorBoundary extends React.Component {\n      constructor(props) {\n        super(props);\n        this.state = { hasError: false };\n      }\n\n      static getDerivedStateFromError(error) {\n        return { hasError: true };\n      }\n\n      componentDidCatch(error, errorInfo) {\n        console.error(`${componentName} component error:`, error, errorInfo);\n        \n        // Track component errors\n        performanceMonitor.recordMetric('componentError', {\n          component: componentName,\n          error: error.message,\n          stack: error.stack\n        });\n      }\n\n      render() {\n        if (this.state.hasError) {\n          // Return fallback component\n          return React.createElement(fallbackComponent, this.props);\n        }\n\n        return this.props.children;\n      }\n    };\n  }\n\n  /**\n   * Wrap component with error boundary and fallback\n   */\n  withFallback(Component, componentName) {\n    const fallbackComponent = this.getFallbackComponent(componentName);\n    \n    if (!fallbackComponent) {\n      return Component;\n    }\n    \n    const ErrorBoundary = this.createErrorBoundary(componentName, fallbackComponent);\n    \n    return React.forwardRef((props, ref) => {\n      return React.createElement(\n        ErrorBoundary,\n        {},\n        React.createElement(Component, { ...props, ref })\n      );\n    });\n  }\n\n  /**\n   * Get compatibility statistics\n   */\n  getCompatibilityStats() {\n    return {\n      shimsActive: this.compatibilityShims.size,\n      fallbacksAvailable: this.fallbackComponents.size,\n      deprecationWarnings: this.deprecationWarnings.size,\n      errorBoundaries: this.errorBoundaries.size\n    };\n  }\n\n  /**\n   * Check if feature is deprecated\n   */\n  isDeprecated(feature) {\n    return Array.from(this.deprecationWarnings).some(warning => \n      warning.includes(feature)\n    );\n  }\n\n  /**\n   * Get migration suggestions\n   */\n  getMigrationSuggestions() {\n    const suggestions = [];\n    \n    this.deprecationWarnings.forEach(warning => {\n      suggestions.push({\n        type: 'deprecation',\n        message: warning,\n        priority: 'medium'\n      });\n    });\n    \n    return suggestions;\n  }\n}\n\n// Create singleton instance\nexport const backwardCompatibilityManager = new BackwardCompatibilityManager();\n\n/**\n * Higher-order component for backward compatibility\n */\nexport const withBackwardCompatibility = (Component, componentName) => {\n  return backwardCompatibilityManager.withFallback(Component, componentName);\n};\n\n/**\n * Hook for backward compatibility\n */\nexport const useBackwardCompatibility = (componentName) => {\n  const [hasFallback, setHasFallback] = React.useState(false);\n  \n  React.useEffect(() => {\n    const fallback = backwardCompatibilityManager.getFallbackComponent(componentName);\n    setHasFallback(!!fallback);\n  }, [componentName]);\n  \n  const transformProps = React.useCallback((props) => {\n    return backwardCompatibilityManager.transformProps(props);\n  }, []);\n  \n  return {\n    hasFallback,\n    transformProps,\n    stats: backwardCompatibilityManager.getCompatibilityStats()\n  };\n};\n\n/**\n * Legacy component wrapper\n */\nexport const LegacyWrapper = ({ children, enableCompatibility = true }) => {\n  if (!enableCompatibility) {\n    return children;\n  }\n  \n  // Apply compatibility transformations to children\n  const compatibleChildren = React.Children.map(children, child => {\n    if (React.isValidElement(child)) {\n      const transformedProps = backwardCompatibilityManager.transformProps(child.props);\n      return React.cloneElement(child, transformedProps);\n    }\n    return child;\n  });\n  \n  return React.createElement(React.Fragment, {}, compatibleChildren);\n};\n\nexport default {\n  BackwardCompatibilityManager,\n  backwardCompatibilityManager,\n  withBackwardCompatibility,\n  useBackwardCompatibility,\n  LegacyWrapper\n};"